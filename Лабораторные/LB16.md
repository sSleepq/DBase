# Практическая работа №16»

## Основная информация
- **Тема:** Аналитические оконные функции и агрегация с группировкой
- **Цель работы:** Приобретение навыков использования оконных функций (LAG, LEAD, ROW_NUMBER, RANK) и сложной агрегации с группировкой по временным периодам для решения аналитических задач бизнеса.

## Исходные данные

Для выполнения работы используются следующие таблицы.

**Таблица `customers` (клиенты):**

| id  | name   |
|-----|--------|
| 1   | John   |
| 2   | Andrew |
| 3   | Kevin  |
| 4   | Mark   |
| 5   | Eric   |

**Таблица `orders` (заказы):**

| id  | customer_id | order_date | total_amount |
|-----|-------------|------------|--------------|
| 1   | 2           | 2023-11-11 | 7500         |
| 2   | 1           | 2023-09-30 | 9000         |
| 3   | 2           | 2023-09-09 | 3200         |
| 4   | 1           | 2023-09-12 | 6700         |
| 5   | 2           | 2023-09-27 | 5500         |
| 6   | 3           | 2023-10-06 | 8200         |
| 7   | 4           | 2023-10-10 | 7300         |
| 8   | 5           | 2023-11-05 | 1200         |
| 9   | 4           | 2023-11-10 | 3600         |
| 10  | 1           | 2023-10-11 | 4500         |

---

## Задания

### Задание 1. Клиент с наибольшим периодом активности
Вам нужно найти клиента с самым длинным периодом между его первым и последним заказом. Выведите:
- `customer_name` (имя клиента)
- `first_order_date` (дата его первого заказа)
- `last_order_date` (дата его последнего заказа)
- `days_between` (количество дней между первым и последним заказом, для наглядности)

**Технические требования:**
1. Используйте агрегатные функции `MIN()` и `MAX()` для определения дат первого и последнего заказа по каждому клиенту.
2. Используйте функцию `DATEDIFF()` (или аналогичную, в зависимости от СУБД) для вычисления разницы в днях между датами.
3. Результат должен содержать только одного клиента (или нескольких, если у них одинаковый максимальный период).
4. Для отбора клиента с максимальным периодом используйте подзапрос с `MAX()` или сортировку с `LIMIT 1`.

---

### Задание 2. Клиенты с максимальным заказом по годам
Измените задачу так, чтобы вы нашли клиентов с максимальной суммой заказа для каждого года. Выведите:
- `customer_name` (имя клиента)
- `order_year` (год заказа)
- `max_order_amount` (максимальная сумма заказа для этого клиента в данном году)

**Уточнение:** Нужно найти не максимальную сумму заказов клиента за год, а максимальную сумму отдельного заказа клиента в каждом году.

**Технические требования:**
1. Используйте функцию `YEAR()` (или аналогичную) для извлечения года из даты заказа.
2. Для каждого года найдите максимальную сумму заказа (`MAX(total_amount)`).
3. Для каждого года определите, какому клиенту принадлежит заказ с этой максимальной суммой.
4. Если в одном году несколько клиентов имеют заказы с одинаковой максимальной суммой, выведите всех их.
5. Используйте оконную функцию `RANK()` или `ROW_NUMBER()` с `PARTITION BY` по году, либо подзапрос с агрегацией.
