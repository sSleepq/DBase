

### **Лекция: Обработка транзакций и использование функций защиты для БД**

**Введение**

Когда мы говорим о реальных приложениях, будь то интернет-банкинг, система продажи билетов или даже простой интернет-магазин, мы часто сталкиваемся с операциями, которые должны быть выполнены как единое целое. Представьте себе процесс перевода денег с одного счета на другой. Эта операция включает в себя два независимых действия: списание суммы с одного счета и зачисление ее на другой. Если после списания денег система даст сбой, и зачисление не произойдет, деньги попросту исчезнут, что является абсолютно недопустимой ситуацией. Именно для предотвращения подобных сценариев и был разработан механизм транзакций.

**Понятие транзакции и ее свойства (ACID)**

Транзакция — это логическая единица работы с базой данных, которая представляет собой последовательность одной или нескольких операций (например, SQL-запросов), которая либо выполняется целиком, либо не выполняется вовсе. Успешное завершение транзакции фиксируется в базе данных с помощью операции `COMMIT`, а в случае возникновения ошибки все изменения, сделанные в рамках этой транзакции, отменяются операцией `ROLLBACK`.

Чтобы транзакция была корректной и обеспечивала надежность, она должна соответствовать четырем основным свойствам, известным под акронимом ACID.

**Атомарность (Atomicity)** гарантирует, что транзакция будет выполнена как неделимое целое. Все операции транзакции должны быть выполнены успешно, либо ни одна из них не должна быть выполнена. Не допускается ситуация, когда часть операций выполнилась, а другая часть — нет. В нашем примере с переводом денег атомарность гарантирует, что либо обе операции (списание и зачисление) произойдут, либо ни одна из них. Механизм отката (ROLLBACK) является технической реализацией этого свойства.

**Согласованность (Consistency)** означает, что результатом выполнения транзакции должен быть корректный переход базы данных из одного целостного состояния в другое. Все правила, ограничения (constraints), триггеры и бизнес-логика должны быть соблюдены. Если транзакция нарушает какое-либо из этих правил, она не может быть зафиксирована. Например, если в базе данных существует ограничение, что баланс счета не может быть отрицательным, то транзакция, пытающаяся списать сумму, превышающую текущий баланс, будет прервана, и база данных останется в исходном, согласованном состоянии.

**Изолированность (Isolation)** обеспечивает такое выполнение параллельных транзакций, при котором они не мешают друг другу. Каждая транзакция должна быть изолирована от других, как если бы она выполнялась в системе одна. Без должной изоляции могут возникать проблемы, такие как "грязное" чтение (чтение данных, которые еще не зафиксированы другой транзакцией и могут быть отменены), неповторяющееся чтение (когда повторное чтение одних и тех же данных в рамках одной транзакции дает разные результаты из-за изменений, внесенных другими транзакциями) и фантомное чтение (появление новых строк при повторном выполнении запроса). Уровни изоляции, которые мы рассмотрим далее, позволяют управлять этим компромиссом.

**Долговечность (Durability)** — это свойство, которое гарантирует, что一旦 транзакция была зафиксирована (COMMIT), ее результаты будут сохранены в базе данных постоянно, даже в случае последующего сбоя системы (например, отключения электропитания). Обычно это обеспечивается путем записи всех изменений в журнал транзакций до того, как клиенту будет отправлено подтверждение об успешной фиксации. Этот журнал часто хранится на устойчивых носителях информации.

**Уровни изоляции транзакций**

Поскольку полная изоляция транзакций может негативно сказываться на производительности системы из-за блокировок, в современных СУБД существуют различные уровни изоляции, которые позволяют ослабить строгость изоляции в обмен на большую производительность.

Стандарт SQL определяет четыре основных уровня изоляции, которые мы располагаем в порядке возрастания строгости и, как следствие, уменьшения производительности.

**Read Uncommitted (Чтение незафиксированных данных)** — это самый низкий уровень изоляции. На этом уровне транзакция может видеть незафиксированные изменения других параллельных транзакций. Это может привести к "грязному" чтению, когда вы читаете данные, которые впоследствии могут быть отменены другой транзакцией. Этот уровень используется крайне редко, так как ставит под угрозу целостность данных.

**Read Committed (Чтение зафиксированных данных)** — это уровень, на котором транзакция видит только те данные, которые были зафиксированы другими транзакциями к моменту начала ее выполнения. Он предотвращает "грязное" чтение, но не защищает от неповторяющегося чтения и фантомного чтения. Это уровень изоляции по умолчанию во многих СУБД, таких как PostgreSQL и Oracle.

**Repeatable Read (Повторяемое чтение)** гарантирует, что если транзакция повторно читает одни и те же данные, она получит один и тот же результат. Достигается это за счет блокировки считываемых строк, что предотвращает их изменение другими транзакциями. Этот уровень предотвращает "грязное" и неповторяющееся чтение, но фантомное чтение все еще возможно.

**Serializable (Упорядочиваемость)** — это самый строгий уровень изоляции. Он гарантирует, что результат параллельного выполнения нескольких транзакций будет идентичен результату их последовательного выполнения. На этом уровне полностью предотвращаются все аномалии: "грязное" чтение, неповторяющееся чтение и фантомное чтение. Достигается это за счет серьезных блокировок, что может сильно снизить пропускную способность системы.

**Функции защиты базы данных**

Помимо механизма транзакций, база данных обладает целым арсеналом функций защиты, которые обеспечивают сохранность и конфиденциальность данных. Эти функции можно разделить на несколько ключевых направлений.

Одним из главных аспектов защиты является **аутентификация и авторизация**. Аутентификация — это процесс проверки подлинности пользователя, например, с помощью логина и пароля. После того как пользователь доказал свою идентичность, система определяет, какие действия ему разрешено выполнять. Этот процесс называется авторизацией. В современных СУБД это реализуется через сложные системы привилегий и ролей. Администратор может создать роль, например, `analyst`, и назначить ей право только на чтение определенных таблиц, а затем назначить эту роль конкретным пользователям. Это позволяет реализовать принцип минимальных привилегий, когда пользователь получает ровно те права, которые необходимы для его работы, и не более.

Другим критически важным механизмом является **резервное копирование и восстановление**. Ни одна система не застрахована от сбоев аппаратного обеспечения, человеческих ошибок или катастроф. Регулярное создание резервных копий данных — это единственный надежный способ восстановить работу после серьезного инцидента. Стратегия резервного копирования обычно включает в себя полные бэкапы (копия всей БД), дифференциальные (копия изменений с момента последнего полного бэкапа) и инкрементные (копия изменений с момента последнего бэкапа любого типа). Не менее важным является и регулярное тестирование процедуры восстановления, чтобы быть уверенным, что в критический момент процесс пройдет успешно.

Для защиты данных "в покое" и "в движении" используется **шифрование**. Шифрование данных на диске защищает информацию в случае физической кражи сервера или жесткого диска. Шифрование передаваемых данных между клиентом и сервером БД (например, с использованием протокола TLS) предотвращает перехват информации по сети. Современные СУБД предоставляют встроенные средства для прозрачного шифрования данных.

Наконец, **аудит и мониторинг** являются неотъемлемой частью защиты. Ведение детального журнала аудита позволяет отслеживать, кто, когда и какие действия выполнял в базе данных. Это критически важно для расследования инцидентов безопасности, соблюдения нормативных требований и выявления подозрительной активности. Мониторинг активности в реальном времени помогает быстро реагировать на потенциальные атаки или аномальное поведение системы.

**Заключение**

Таким образом, обработка транзакций и функции защиты базы данных представляют собой не просто набор технических features, а комплексную философию построения надежных, отказоустойчивых и безопасных систем. Механизм транзакций, основанный на свойствах ACID, обеспечивает логическую целостность и предсказуемость работы с данными. В то же время, такие функции, как управление доступом, шифрование, резервное копирование и аудит, создают многоуровневую систему безопасности, защищающую данные от широкого спектра угроз. Понимание и грамотное применение этих механизмов является обязательным навыком для любого специалиста, работающего с базами данных.